<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<!-- 不使用namespace的话sql搜索定位会比较方便 -->
<mapper namespace="Classroom">

    <resultMap id="rs_base" type="Classroom">
        <result property="id" column="id"/>
        <result property="classroomCode" column="classroomCode"/>
        <result property="assistantCode" column="assistantCode"/>
        <result property="assistantName" column="assistantName"/>
        <result property="assistantEmail" column="assistantEmail"/>
        <result property="timetableCode" column="timetableCode"/>
        <result property="course" column="course"/>
        <result property="type" column="type"/>
        <result property="state" column="state"/>
        <result property="numType" column="numType"/>
        <result property="num" column="num"/>
        <result property="duration" column="duration"/>
        <result property="week" column="week"/>
        <result property="amAndPm" column="amAndPm"/>
        <result property="courseTime" column="courseTime"/>
        <result property="costHour" column="costHour"/>
        <result property="courseHourType" column="courseHourType"/>
        <result property="assiTimeZone" column="assiTimeZone"/>
        <result property="startTime" column="startTime"/>
        <result property="endTime" column="endTime"/>
        <result property="isVideo" column="isVideo"/>
        <result property="isCancel" column="isCancel"/>
        <result property="isCreateZoom" column="isCreateZoom"/>
        <result property="updateTime" column="updateTime"/>
    </resultMap>


    <!--所有信息-->
    <resultMap id="rs_base_all" type="Classroom" extends="rs_base">
        <association property="courseTimetable" column="{timetableCode=timetableCode}" select="CourseTimetable.loadCourseTimetable4Classroom"/>
        <association property="classroomZoom" column="{classroomCode=classroomCode}" select="ClassroomZoom.load"/>
        <association property="classroomVideo" column="{classroomCode=classroomCode}" select="ClassroomVideo.loadByClassroomCode"/>
        <collection property="classroomLeavemessages" column="{classroomCode=classroomCode}" select="ClassroomLeavemessage.query"/>
        <collection property="classroomTutors" column="{classroomCode=classroomCode}" select="ClassroomTutor.query"/>
        <collection property="classroomStudentses" column="{classroomCode=classroomCode}" select="ClassroomStudents.query"/>
        <!--<collection property="classroomCoursewares" column="{classroomCode=classroomCode}" select="ClassroomCourseware.query"/>-->
        <collection property="classroomFeedbacks" column="{classroomCode=classroomCode}" select="ClassroomFeedback.classroomFeedbacks"/>
        <collection property="classroomNotifys" column="{classroomCode=classroomCode}" select="ClassroomNotify.classroomNotifys"/>
        <collection property="classroomTraces" column="{classroomCode=classroomCode}" select="ClassroomTrace.query"/>
    </resultMap>

    <!--查询课堂初步分页信息-->
    <resultMap id="rs_base_query" type="Classroom" extends="rs_base">
        <collection property="classroomLeavemessages" column="{classroomCode=classroomCode}" select="ClassroomLeavemessage.loadByClassroomCode"/>
        <collection property="classroomTutors" column="{classroomCode=classroomCode}" select="ClassroomTutor.query"/>
        <collection property="classroomStudentses" column="{classroomCode=classroomCode}" select="ClassroomStudents.query"/>
    </resultMap>


    <!-- 用于select查询公用抽取的列 -->
    <sql id="Classroom.columns">
        id,classroomCode,assistantCode,assistantName,assistantEmail,timetableCode,type,course,state,num,numType,duration,week,amAndPm,courseTime,costHour,courseHourType,assiTimeZone,startTime,endTime,isVideo,isCancel,isCreateZoom,updateTime
    </sql>

    <insert id="Classroom.insert" useGeneratedKeys="true" keyProperty="id" parameterType="Classroom">
        INSERT INTO Classroom (
        id ,
        classroomCode ,
        assistantCode ,
        assistantName ,
        assistantEmail ,
        timetableCode ,
        course ,
        `type`,
        state ,
        num ,
        numType ,
        duration ,
        week ,
        amAndPm ,
        courseTime ,
        costHour ,
        courseHourType ,
        assiTimeZone ,
        startTime ,
        endTime ,
        isVideo ,
        isCancel ,
        isCreateZoom ,
        updateTime
        ) VALUES (
        #{id} ,
        #{classroomCode} ,
        #{assistantCode} ,
        #{assistantName} ,
        #{assistantEmail} ,
        #{timetableCode} ,
        #{course} ,
        #{type} ,
        #{state} ,
        #{num} ,
        #{numType} ,
        #{duration} ,
        #{week} ,
        #{amAndPm} ,
        #{courseTime} ,
        #{costHour} ,
        #{courseHourType} ,
        #{assiTimeZone} ,
        #{startTime} ,
        #{endTime} ,
        #{isVideo} ,
        #{isCancel} ,
        #{isCreateZoom} ,
        #{updateTime}
        )
        <selectKey keyProperty="id" resultType="long">
            select LAST_INSERT_ID()
        </selectKey>
    </insert>

    <update id="Classroom.update" parameterType="Classroom">
        UPDATE Classroom
        <trim prefix="set" suffixOverrides=",">
            <if test="assistantCode!=null and assistantCode!=''">
                assistantCode = #{assistantCode} ,
            </if>
            <if test="assistantName!=null and assistantName!=''">
                assistantName = #{assistantName} ,
            </if>
            <if test="assistantEmail!=null and assistantEmail!=''">
                assistantEmail = #{assistantEmail} ,
            </if>
            <if test="timetableCode!=null and timetableCode!=''">
                timetableCode = #{timetableCode} ,
            </if>
            <if test="course!=null and course!=''">
                course = #{course} ,
            </if>
            <if test="type!=null and type!=''">
                `type` = #{type} ,
            </if>
            <if test="state!=null and state!=''">
                state = #{state} ,
            </if>
            <if test="num!=null and num!=''">
                num = #{num} ,
            </if>
            <if test="numType!=null and numType!=''">
                numType = #{numType} ,
            </if>
            <if test="duration!=null and duration!=''">
                duration = #{duration} ,
            </if>
            <if test="week!=null and week!=''">
                week = #{week} ,
            </if>
            <if test="amAndPm!=null ">
                amAndPm = #{amAndPm} ,
            </if>
            <if test="courseTime!=null ">
                courseTime = #{courseTime} ,
            </if>
            <if test="costHour!=null and costHour!=''">
                costHour = #{costHour} ,
            </if>
            <if test="courseHourType!=null and courseHourType!=''">
                courseHourType = #{courseHourType} ,
            </if>
            <if test="assiTimeZone!=null and assiTimeZone!=''">
                assiTimeZone = #{assiTimeZone} ,
            </if>
            <if test="startTime!=null ">
                startTime = #{startTime} ,
            </if>
            <if test="endTime!=null">
                endTime = #{endTime} ,
            </if>
            <if test="isVideo!=null and isVideo!=''">
                isVideo = #{isVideo} ,
            </if>
            <if test="isCancel!=null and isCancel!=''">
                isCancel = #{isCancel} ,
            </if>
            <if test="isCreateZoom!=null and isCreateZoom!=''">
                isCreateZoom = #{isCreateZoom} ,
            </if>
            <if test="updateTime!=null ">
                updateTime = #{updateTime}
            </if>
            <if test="updateTimeBegin!=null ">
                updateTime >= #{updateTimeBegin}
            </if>
            <if test="updateTimeEnd!=null ">
                updateTime &lt;= #{updateTimeEnd}
            </if>
        </trim>

        WHERE
        classroomCode = #{classroomCode}
    </update>

    <delete id="Classroom.delete">
        DELETE FROM Classroom WHERE
        classroomCode = #{classroomCode}
    </delete>

    <select id="Classroom.load" resultMap="rs_base">
        SELECT
        <include refid="Classroom.columns"/>
        FROM Classroom
        WHERE
        classroomCode = #{classroomCode}
    </select>

    <sql id="Classroom.where">
        <where>

            <if test="classroomCode!=null and classroomCode!=''">
                AND classroomCode = #{classroomCode}
            </if>
            <if test="assistantCode!=null and assistantCode!=''">
                AND assistantCode = #{assistantCode}
            </if>
            <if test="assistantName!=null and assistantName!=''">
                AND assistantName = #{assistantName}
            </if>
            <if test="assistantEmail!=null and assistantEmail!=''">
                AND assistantEmail = #{assistantEmail}
            </if>
            <if test="timetableCode!=null and timetableCode!=''">
                AND timetableCode = #{timetableCode}
            </if>
            <if test="course!=null and course!=''">
                AND course = #{course}
            </if>
            <if test="type!=null and type!=''">
                AND type = #{type}
            </if>
            <if test="state!=null and state!=''">
                AND state = #{state}
            </if>
            <if test="num!=null and num!=''">
                AND num = #{num}
            </if>
            <if test="numType!=null and numType!=''">
                AND numType = #{numType}
            </if>

            <if test="states!=null">
                AND state in
                <foreach collection="states" item="state_in" index="index" open="(" close=")" separator=",">
                    #{state_in}
                </foreach>
            </if>

            <if test="duration!=null and duration!=''">
                AND duration = #{duration}
            </if>
            <if test="week!=null and week!=''">
                AND week = #{week}
            </if>
            <if test="amAndPm!=null and amAndPm!=''">
                AND amAndPm = #{amAndPm}
            </if>
            <if test="courseTimeBegin!=null ">
                AND courseTime >= #{courseTimeBegin}
            </if>
            <if test="courseTimeEnd!=null ">
                AND courseTime &lt;= #{courseTimeEnd}
            </if>
            <if test="costHour!=null and costHour!=''">
                AND costHour = #{costHour}
            </if>
            <if test="courseHourType!=null and courseHourType!=''">
                AND courseHourType = #{courseHourType}
            </if>
            <if test="assiTimeZone!=null and assiTimeZone!=''">
                AND assiTimeZone = #{assiTimeZone}
            </if>
            <if test="startTimeBegin!=null ">
                AND startTime >= #{startTimeBegin}
            </if>
            <if test="startTimeEnd!=null ">
                AND startTime &lt;= #{startTimeEnd}
            </if>
            <if test="endTimeBegin!=null ">
                AND endTime >= #{endTimeBegin}
            </if>
            <if test="endTimeEnd!=null">
                AND endTime &lt;= #{endTimeEnd}
            </if>
            <if test="isVideo!=null and isVideo!=''">
                AND isVideo = #{isVideo}
            </if>
            <if test="isCancel!=null and isCancel!=''">
                AND isCancel = #{isCancel}
            </if>
            <if test="isCreateZoom!=null and isCreateZoom!=''">
                AND isCreateZoom = #{isCreateZoom}
            </if>
            <if test="updateTimeBegin!=null ">
                AND updateTime >= #{updateTimeBegin}
            </if>
            <if test="updateTimeEnd!=null ">
                AND updateTime &lt;= #{updateTimeEnd}
            </if>
            <if test="overtime!=null ">
                AND TIMESTAMPDIFF(MINUTE,endTime,#{nowDate}) > #{overtime}
            </if>
        </where>
    </sql>


    <select id="Classroom.count" resultType="int">
        SELECT count(1) FROM Classroom
        <include refid="Classroom.where"/>
    </select>


    <select id="Classroom.query" resultMap="rs_base_query">
        SELECT
        <include refid="Classroom.columns"/>
        FROM Classroom
        <include refid="Classroom.where"/>
        ORDER BY classroomCode DESC
    </select>


    <!--查询课堂集合-->
    <select id="Classroom.classrooms" resultMap="rs_base">
        SELECT
        <include refid="Classroom.columns"/>
        FROM Classroom where tutorCode=#{tutorCode}
        ORDER BY endTime DESC

    </select>

    <!--加载一个课堂(基础信息仅有 课堂信息)-->
    <select id="Classroom.loadByState" resultMap="rs_base">
        SELECT * FROM Classroom
        <where>
            <if test="classroomCode!=null and classroomCode!=''">
                AND classroomCode = #{classroomCode}
            </if>
            <if test="states!=null">
                AND state in
                <foreach collection="states" item="state_in" index="index" open="(" close=")" separator=",">
                    #{state_in}
                </foreach>
            </if>
        </where>
        limit 1
    </select>

    <!--加载一个课堂(课堂相关的所有信息)-->
    <select id="Classroom.loadAll" resultMap="rs_base_all">
        SELECT * FROM Classroom
        <where>
            <if test="classroomCode!=null and classroomCode!=''">
                AND classroomCode = #{classroomCode}
            </if>
            <if test="timetableCode!=null and timetableCode!=''">
                AND timetableCode = #{timetableCode}
            </if>

            <if test="state!=null and state!=''">
                AND state in
                <foreach collection="states" item="state_in" index="index" open="(" close=")" separator=",">
                    #{state_in}
                </foreach>
            </if>
        </where>
        limit 1
    </select>

    <!--修改课堂信息-->
    <update id="Classroom.updateByState" parameterType="Classroom">
        UPDATE Classroom SET
        state = #{newState} ,
        updateTime = #{updateTime}
        WHERE
        classroomCode = #{classroomCode}
        and state=#{oldState}
    </update>


    <!--查询课堂列表-->
    <select id="Classroom.listClassroom" resultMap="rs_base_query">
        SELECT
        <include refid="Classroom.columns"/>
        FROM Classroom
        <include refid="Classroom.listwhere"/>

        <if test="sortColumns!=null and sortColumns!=''">
            ORDER BY ${sortColumns}
        </if>
    </select>

    <select id="Classroom.countClassroom" resultType="int">
        SELECT COUNT(1) FROM Classroom
        <include refid="Classroom.listwhere"/>
    </select>

    <sql id="Classroom.listwhere">
        <where>
            <if test="classroomCode!=null and classroomCode!=''">
                AND classroomCode = #{classroomCode}
            </if>
            <if test="assistantCode!=null and assistantCode!=''">
                AND assistantCode = #{assistantCode}
            </if>
            <if test="assistantName!=null and assistantName!=''">
                AND assistantName = #{assistantName}
            </if>
            <if test="assistantEmail!=null and assistantEmail!=''">
                AND assistantEmail = #{assistantEmail}
            </if>
            <if test="timetableCode!=null and timetableCode!=''">
                AND timetableCode = #{timetableCode}
            </if>
            <if test="course!=null and course!=''">
                AND course = #{course}
            </if>
            <if test="type!=null and type!=''">
                AND type = #{type}
            </if>
            <if test="state!=null and state!=''">
                AND state = #{state}
            </if>
            <if test="num!=null and num!=''">
                AND num = #{num}
            </if>
            <if test="numType!=null and numType!=''">
                AND numType = #{numType}
            </if>
            <if test="duration!=null and duration!=''">
                AND duration = #{duration}
            </if>
            <if test="week!=null and week!=''">
                AND week = #{week}
            </if>
            <if test="amAndPm!=null and amAndPm!=''">
                AND amAndPm = #{amAndPm}
            </if>
            <if test="courseTimeBegin!=null ">
                AND courseTime >= #{courseTimeBegin}
            </if>
            <if test="courseTimeEnd!=null ">
                AND courseTime &lt;= #{courseTimeEnd}
            </if>
            <if test="costHour!=null and costHour!=''">
                AND costHour = #{costHour}
            </if>
            <if test="courseHourType!=null and courseHourType!=''">
                AND courseHourType = #{courseHourType}
            </if>
            <if test="assiTimeZone!=null and assiTimeZone!=''">
                AND assiTimeZone = #{assiTimeZone}
            </if>
            <if test="startTimeBegin!=null ">
                AND startTime >= #{startTimeBegin}
            </if>
            <if test="startTimeEnd!=null ">
                AND startTime &lt;= #{startTimeEnd}
            </if>
            <if test="endTimeBegin!=null ">
                AND endTime >= #{endTimeBegin}
            </if>
            <if test="endTimeEnd!=null">
                AND endTime &lt;= #{endTimeEnd}
            </if>
            <if test="isVideo!=null and isVideo!=''">
                AND isVideo = #{isVideo}
            </if>
            <if test="isCancel!=null and isCancel!=''">
                AND isCancel = #{isCancel}
            </if>
            <if test="isCreateZoom!=null and isCreateZoom!=''">
                AND isCreateZoom = #{isCreateZoom}
            </if>
            <if test="updateTimeBegin!=null ">
                AND updateTime >= #{updateTimeBegin}
            </if>
            <if test="updateTimeEnd!=null ">
                AND updateTime &lt;= #{updateTimeEnd}
            </if>
        </where>
    </sql>


    <!--教师查询课堂信息-->
    <select id="Classroom.query4Tutor" resultMap="rs_base_all">
        SELECT c.* from Classroom c, classroom_tutor ct
        where c.classroomCode=ct.classroomCode and ct.tutorCode=#{tutorCode}
        <if test="states!=null and states!=''">
            AND c.state in (#{states})
        </if>
        <if test="assistantCode!=null and assistantCode!=''">
            AND c.assistantCode = #{assistantCode}
        </if>
        <if test="sortColumns!=null and sortColumns!=''">
            ORDER BY ${sortColumns}
        </if>
    </select>


    <!--学生查询课堂信息-->
    <select id="Classroom.query4Student" resultMap="rs_base_all">
        SELECT c.* from Classroom c, classroom_students cs
        where c.classroomCode=cs.classroomCode and cs.studentCode=#{studentCode}
        <if test="states!=null and states!=''">
            AND c.state in (#{states})
        </if>
        ORDER BY startTime
    </select>

    <!--查询教师所有已经上课 按照时间顺序倒叙排序-->
    <select id="Classroom.finshedclassrooms" resultMap="rs_base_all">
        SELECT c.* from Classroom c, classroom_tutor ct
        where c.classroomCode=ct.classroomCode and ct.tutorCode=#{tutorCode}

        <if test="states!=null and states!=''">
            AND c.state in
            <foreach collection="states" item="state_in" index="index" open="(" close=")" separator=",">
                #{state_in}
            </foreach>
        </if>

        <if test="sortColumns!=null and sortColumns!=''">
            ORDER BY ${sortColumns}
        </if>

    </select>

    <select id="Classroom.countFinshedclassrooms" resultType="int">
        SELECT count(1) from Classroom c, classroom_tutor ct
        where c.classroomCode=ct.classroomCode and ct.tutorCode=#{tutorCode}

        <if test="states!=null and states!=''">
            AND c.state in
            <foreach collection="states" item="state_in" index="index" open="(" close=")" separator=",">
                #{state_in}
            </foreach>
        </if>

    </select>


    <!--查询学生所有已经上课 按照时间顺序倒叙排序-->
    <select id="Classroom.ended4Student" resultMap="rs_base_all">
        SELECT c.* from Classroom c, classroom_students cs
        where c.classroomCode=cs.classroomCode and cs.studentCode=#{studentCode}

        <if test="states!=null and states!=''">
            AND c.state in
            <foreach collection="states" item="state_in" index="index" open="(" close=")" separator=",">
                #{state_in}
            </foreach>
        </if>

        <if test="sortColumns!=null and sortColumns!=''">
            ORDER BY ${sortColumns}
        </if>
    </select>

    <select id="Classroom.countEnded4Student" resultType="int">
        SELECT count(1) from Classroom c, classroom_students cs
        where c.classroomCode=cs.classroomCode and cs.studentCode=#{studentCode}

        <if test="states!=null and states!=''">
            AND c.state in
            <foreach collection="states" item="state_in" index="index" open="(" close=")" separator=",">
                #{state_in}
            </foreach>
        </if>
    </select>

    <!--查询学生取消的课堂列表-->
    <select id="Classroom.listClassroom4Student" resultMap="rs_base_query">
        SELECT c.* from Classroom c, classroom_students cs
        where
         c.classroomCode=cs.classroomCode
        and cs.studentCode=#{studentCode}
        and c.state=#{state}
    </select>

    <!--查询课老师已被学生取消堂列表-->
    <select id="Classroom.listClassroom4Tutor" resultMap="rs_base_query">
        SELECT c.* from Classroom c, classroom_tutor ct
        where
         c.classroomCode=ct.classroomCode
        and ct.tutorCode=#{tutorCode}
        and c.state=#{state}
    </select>


    <!--查询课堂列表-->
    <select id="Classroom.search4Tutor" resultMap="rs_base_query">
        SELECT c.* from Classroom c, classroom_tutor ct
        where
        c.classroomCode=ct.classroomCode
        <if test="state!=null and state!=''">
            AND c.state =#{state}
        </if>
        <if test="assistantCode!=null and assistantCode!=''">
            AND c.assistantCode = #{assistantCode}
        </if>
        <if test="tutorCode!=null and tutorCode!=''">
            AND ct.tutorCode = #{tutorCode}
        </if>
        <if test="sortColumns!=null and sortColumns!=''">
            ORDER BY ${sortColumns}
        </if>
    </select>

    <select id="Classroom.countSearch4Tutor" resultType="int">
        SELECT count(1) from Classroom c, classroom_tutor ct
        where
        c.classroomCode=ct.classroomCode
        <if test="state!=null and state!=''">
            AND c.state =#{state}
        </if>
        <if test="assistantCode!=null and assistantCode!=''">
            AND c.assistantCode = #{assistantCode}
        </if>
        <if test="tutorCode!=null and tutorCode!=''">
            AND ct.tutorCode = #{tutorCode}
        </if>
        <if test="sortColumns!=null and sortColumns!=''">
            ORDER BY ${sortColumns}
        </if>
    </select>


    <!--关闭超时过期未上课的课堂和学生-->
    <update id="Classroom.closeOverdue" parameterType="Classroom">
        UPDATE Classroom
        <trim prefix="set" suffixOverrides=",">
            <if test="state!=null and state!=''">
                state = #{state} ,
            </if>
            <if test="isCancel!=null and isCancel!=''">
                isCancel = #{isCancel} ,
            </if>
            <if test="updateTime!=null ">
                updateTime = #{updateTime}
            </if>
        </trim>
        WHERE
        classroomCode=#{classroomCode}
        AND endTime &lt;= #{overtime}
        AND state in
        <foreach collection="states" item="state_in" index="index" open="(" close=")" separator=",">
            #{state_in}
        </foreach>
    </update>

    <!--关闭已经开课但严重超时的课堂-->
    <update id="Classroom.closevertime" parameterType="Classroom">
        UPDATE Classroom
        <trim prefix="set" suffixOverrides=",">
            <if test="state!=null and state!=''">
                state = #{state} ,
            </if>
            <if test="isCancel!=null and isCancel!=''">
                isCancel = #{isCancel} ,
            </if>
            <if test="updateTime!=null ">
                updateTime = #{updateTime}
            </if>
        </trim>
        WHERE
        classroomCode=#{classroomCode}
        AND endTime &lt;= #{overtime}
        AND state in
        <foreach collection="states" item="state_in" index="index" open="(" close=")" separator=",">
            #{state_in}
        </foreach>
    </update>


    <!--关闭超时取消的操作-->
    <update id="Classroom.closeCancelBooking" parameterType="Classroom">
        UPDATE Classroom
        <trim prefix="set" suffixOverrides=",">
            <if test="isCancel!=null and isCancel!=''">
                isCancel = #{isCancel} ,
            </if>
            <if test="updateTime!=null ">
                updateTime = #{updateTime}
            </if>
        </trim>
        WHERE
        classroomCode=#{classroomCode}
        AND state in
        <foreach collection="states" item="state_in" index="index" open="(" close=")" separator=",">
            #{state_in}
        </foreach>
    </update>

</mapper>

