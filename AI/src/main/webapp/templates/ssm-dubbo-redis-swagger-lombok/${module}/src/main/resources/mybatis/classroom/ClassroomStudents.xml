<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<!-- 不使用namespace的话sql搜索定位会比较方便 -->
<mapper namespace="ClassroomStudents">

    <resultMap id="rs_base" type="ClassroomStudents">
        <result property="id" column="id"/>
        <result property="classroomCode" column="classroomCode"/>
        <result property="studentCode" column="studentCode"/>
        <result property="studentName" column="studentName"/>
        <result property="studentEmail" column="studentEmail"/>
        <result property="timeZone" column="timeZone"/>
        <result property="state" column="state"/>
        <result property="isFeedback" column="isFeedback"/>
        <result property="isTutorFeedback" column="isTutorFeedback"/>
    </resultMap>

    <resultMap id="rs_base_all" type="ClassroomStudents" extends="rs_base">
        <association property="student" column="{studentCode=studentCode}" select="Student.load"/>
    </resultMap>

    <resultMap id="rs_base_Classroom" type="ClassroomStudents" extends="rs_base">
        <association property="classroom" column="{classroomCode=classroomCode}" select="Classroom.loadAll"/>
    </resultMap>

    <!-- 用于select查询公用抽取的列 -->
    <sql id="ClassroomStudents.columns">
		id,classroomCode,studentCode,studentName,studentEmail,timeZone,state,isFeedback,isTutorFeedback
	</sql>

    <insert id="ClassroomStudents.insert" useGeneratedKeys="true" keyProperty="id" parameterType="ClassroomStudents">
        INSERT INTO `classroom_students` (
        id ,
        classroomCode ,
        studentCode ,
        studentName ,
        studentEmail ,
        timeZone ,
        state,
        isFeedback,
        isTutorFeedback
        ) VALUES (
        #{id} ,
        #{classroomCode} ,
        #{studentCode} ,
        #{studentName} ,
        #{studentEmail} ,
        #{timeZone} ,
        #{state},
        #{isFeedback},
        #{isTutorFeedback}
        )
        <selectKey keyProperty="id" resultType="long">
            select LAST_INSERT_ID()
        </selectKey>
    </insert>

    <update id="ClassroomStudents.update" parameterType="ClassroomStudents">
        UPDATE `classroom_students`
        <trim prefix="set" suffixOverrides=",">
            <if test="studentName!=null and studentName!=''">
                studentName = #{studentName} ,
            </if>
            <if test="studentEmail!=null and studentEmail!=''">
                studentEmail = #{studentEmail} ,
            </if>
            <if test="timeZone!=null and timeZone!=''">
                timeZone = #{timeZone} ,
            </if>
            <if test="state!=null and state!=''">
                state = #{state},
            </if>
            <if test="isFeedback!=null and isFeedback!=''">
                isFeedback = #{isFeedback},
            </if>
            <if test="isTutorFeedback!=null and isTutorFeedback!=''">
                isTutorFeedback = #{isTutorFeedback}
            </if>
        </trim>

        <where>
            <if test="classroomCode!=null and classroomCode!=''">
                AND classroomCode = #{classroomCode}
            </if>
            <if test="studentCode!=null and studentCode!=''">
                AND studentCode = #{studentCode}
            </if>
        </where>
    </update>

    <delete id="ClassroomStudents.delete">
        DELETE FROM `classroom_students`
        <include refid="ClassroomStudents.where"/>
    </delete>

    <select id="ClassroomStudents.load" resultMap="rs_base">
        SELECT
        <include refid="ClassroomStudents.columns"/>
        FROM `classroom_students`
        <include refid="ClassroomStudents.where"/>
    </select>

    <sql id="ClassroomStudents.where">
        <where>
            <if test="id!=null and id!=''">
                AND id = #{id}
            </if>
            <if test="classroomCode!=null and classroomCode!=''">
                AND classroomCode = #{classroomCode}
            </if>
            <if test="studentCode!=null and studentCode!=''">
                AND studentCode = #{studentCode}
            </if>
            <if test="studentName!=null and studentName!=''">
                AND studentName = #{studentName}
            </if>
            <if test="studentEmail!=null and studentEmail!=''">
                AND studentEmail = #{studentEmail}
            </if>
            <if test="timeZone!=null and timeZone!=''">
                AND timeZone = #{timeZone}
            </if>
            <if test="state!=null and state!=''">
                AND state = #{state}
            </if>
            <if test="isFeedback!=null and isFeedback!=''">
                AND isFeedback = #{isFeedback}
            </if>
            <if test="isTutorFeedback!=null and isTutorFeedback!=''">
                AND isTutorFeedback = #{isTutorFeedback}
            </if>
            <if test="states!=null and states!=''">
                AND state in
                <foreach collection="states" item="state_in" index="index" open="(" close=")" separator=",">
                    #{state_in}
                </foreach>
            </if>
        </where>
    </sql>


    <select id="ClassroomStudents.count" resultType="long">
        SELECT count(*) FROM `classroom_students`
        <include refid="ClassroomStudents.where"/>
    </select>


    <select id="ClassroomStudents.query" resultMap="rs_base_all">
        SELECT
        <include refid="ClassroomStudents.columns"/>
        FROM `classroom_students`
        <include refid="ClassroomStudents.where"/>
        ORDER BY id DESC
    </select>


    <!--查询学生所有信息关于课堂内容-->
    <select id="ClassroomStudents.loadClassroomStudents" resultMap="rs_base_Classroom">
        SELECT cs.* FROM `classroom_students` cs,Student s
        WHERE
        cs.studentCode=s.studentCode
        AND
        cs.studentCode=#{studentCode}
        <if test="states!=null">
            AND cs.state in
            <foreach collection="states" item="state_in" index="index" open="(" close=")" separator=",">
                #{state_in}
            </foreach>
        </if>
        ORDER BY cs.id DESC
    </select>


    <!--查询学生取消的课堂列表-->
    <select id="ClassroomStudents.listClassroomStudents" resultMap="rs_base_Classroom">
        SELECT cs.* FROM `classroom_students` cs,Student s
        WHERE
        cs.studentCode=s.studentCode
        AND
        cs.studentCode=#{studentCode}
        AND
        cs.state =#{state}
        ORDER BY cs.id DESC
    </select>


    <!--查询状态为确认的课堂且学生为预约状态的学生集合-->
    <select id="ClassroomStudents.listBookAndClassroomConfirmed" resultMap="rs_base">
        SELECT cs.* FROM `classroom_students` cs,Classroom c
        WHERE
        cs.classroomCode=c.classroomCode
        AND
        cs.state =#{state}
        AND
        c.state=#{classroomState}
        ORDER BY cs.id DESC
    </select>

    <!--查询学生预约指定课程的课堂信息-->
    <select id="ClassroomStudents.findClassroomByStudents" resultMap="rs_base_Classroom">
        SELECT cs.* FROM `classroom_students` cs,Classroom c
        WHERE
        cs.classroomCode=c.classroomCode
        AND
        cs.studentCode=#{studentCode}
        AND
        c.timetableCode=#{timetableCode}
        <if test="states!=null">
            AND cs.state in
            <foreach collection="states" item="state_in" index="index" open="(" close=")" separator=",">
                #{state_in}
            </foreach>
        </if>
    </select>


</mapper>

