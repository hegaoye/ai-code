<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<!-- 不使用namespace的话sql搜索定位会比较方便 -->
<mapper namespace="CourseTimetable">

    <resultMap id="rs_base" type="CourseTimetable">
        <result property="id" column="id"/>
        <result property="timetableCode" column="timetableCode"/>
        <result property="courseCode" column="courseCode"/>
        <result property="tutorCode" column="tutorCode"/>
        <result property="tuTimeZone" column="tuTimeZone"/>
        <result property="course" column="course"/>
        <result property="courseTime" column="courseTime"/>
        <result property="week" column="week"/>
        <result property="duration" column="duration"/>
        <result property="amAndPm" column="amAndPm"/>
        <result property="num" column="num"/>
        <result property="bookNum" column="bookNum"/>
        <result property="advanceTime" column="advanceTime"/>
        <result property="courseHour" column="courseHour"/>
        <result property="courseHourType" column="courseHourType"/>
        <result property="state" column="state"/>
        <result property="createTime" column="createTime"/>
        <result property="updateTime" column="updateTime"/>
        <result property="vn" column="vn"/>
    </resultMap>


    <!--所有信息-->
    <resultMap id="rs_base_all" type="CourseTimetable" extends="rs_base">
        <association property="tutor" column="{tutorCode=tutorCode}" select="Tutor.loadTutor"/>
    </resultMap>

    <resultMap id="rs_base4classroom" type="CourseTimetable" extends="rs_base">
        <collection property="courseCourseWares" column="{courseCode=courseCode}" select="CourseCourseWare.load"/>
    </resultMap>

    <!--根据条件搜索课程-->
    <resultMap id="rs_base_all4Search" type="CourseTimetable" extends="rs_base">
        <association property="tutor" column="{tutorCode=tutorCode}" select="Tutor.loadTutor"/>
        <association property="classroomFeedback" column="{tutorCode=tutorCode}" select="ClassroomFeedback.countFeedbackTotal"/>
        <association property="tutorFavorite" column="{tutorCode=tutorCode}" select="TutorFavorite.countFavoriteTotal"/>
        <association property="classroomTutor" column="{tutorCode=tutorCode}" select="ClassroomTutor.countClassroomTotal"/>
    </resultMap>


    <!-- 用于select查询公用抽取的列 -->
    <sql id="CourseTimetable.columns">
		id,timetableCode,courseCode,tutorCode,tuTimeZone,course,courseTime,week,duration,amAndPm,num,bookNum,advanceTime,courseHour,courseHourType,state,createTime,updateTime,vn
	</sql>

    <insert id="CourseTimetable.insert" useGeneratedKeys="true" keyProperty="id" parameterType="CourseTimetable">
        INSERT INTO course_timetable (
        id ,
        timetableCode ,
        courseCode ,
        tutorCode ,
        tuTimeZone ,
        course ,
        courseTime ,
        week ,
        duration ,
        amAndPm ,
        num ,
        bookNum ,
        advanceTime ,
        courseHour,
        courseHourType,
        state ,
        createTime ,
        updateTime,
        vn
        ) VALUES (
        #{id} ,
        #{timetableCode} ,
        #{courseCode} ,
        #{tutorCode} ,
        #{tuTimeZone} ,
        #{course} ,
        #{courseTime} ,
        #{week} ,
        #{duration} ,
        #{amAndPm} ,
        #{num} ,
        #{bookNum} ,
        #{advanceTime} ,
        #{courseHour} ,
        #{courseHourType} ,
        #{state} ,
        #{createTime} ,
        #{updateTime},
        1
        )
        <selectKey keyProperty="id" resultType="long">
            select LAST_INSERT_ID()
        </selectKey>
    </insert>

    <update id="CourseTimetable.update" parameterType="CourseTimetable">
        UPDATE course_timetable
        <trim prefix="set" suffixOverrides=",">
            <if test="tutorCode!=null and tutorCode!=''">
                tutorCode = #{tutorCode} ,
            </if>
            <if test="tuTimeZone!=null and tuTimeZone!=''">
                tuTimeZone = #{tuTimeZone} ,
            </if>
            <if test="course!=null and course!=''">
                course= #{course} ,
            </if>
            <if test="courseTime!=null">
                courseTime = #{courseTime} ,
            </if>
            <if test="state!=null and state!=''">
                state = #{state},
            </if>
            <if test="week!=null and week!=''">
                week = #{week} ,
            </if>
            <if test="duration!=null and duration!=''">
                duration = #{duration} ,
            </if>
            <if test="amAndPm!=null and amAndPm!=''">
                amAndPm = #{amAndPm} ,
            </if>
            <if test="num!=null and num!=''">
                num = #{num} ,
            </if>
            <if test="bookNum!=null">
                bookNum = #{bookNum} ,
            </if>
            <if test="advanceTime!=null">
                advanceTime = #{advanceTime} ,
            </if>
            <if test="courseHour!=null ">
                courseHour = #{courseHour} ,
            </if>
            <if test="courseHourType!=null and courseHourType!=''">
                courseHourType = #{courseHourType} ,
            </if>
            <if test="courseHour!=null ">
                courseHour = #{courseHour} ,
            </if>
            <if test="updateTime!=null ">
                updateTime = #{updateTime} ,
            </if>
            <if test="vn!=null and vn!='' ">
                vn = vn+1 ,
            </if>
        </trim>

        WHERE
        timetableCode = #{timetableCode} and vn=#{vn}
    </update>

    <delete id="CourseTimetable.delete">
        DELETE FROM course_timetable WHERE
        id = #{id}  AND 
        timetableCode = #{id} 
    </delete>

    <!--删除一个课表的课时-->
    <delete id="CourseTimetable.deleteBy">
        DELETE FROM course_timetable
        <include refid="CourseTimetable.where"/>
    </delete>

    <select id="CourseTimetable.load" resultMap="rs_base">
        SELECT
        <include refid="CourseTimetable.columns"/>
        FROM course_timetable
        WHERE
        timetableCode = #{timetableCode}
    </select>

    <sql id="CourseTimetable.where">
        <where>
            <if test="timetableCode!=null and timetableCode!=''">
                AND timetableCode = #{timetableCode}
            </if>
            <if test="courseCode!=null and courseCode!=''">
                AND courseCode = #{courseCode}
            </if>
            <if test="tutorCode!=null and tutorCode!=''">
                AND tutorCode = #{tutorCode}
            </if>
            <if test="tuTimeZone!=null and tuTimeZone!=''">
                AND tuTimeZone = #{tuTimeZone}
            </if>
            <if test="course!=null and course!=''">
                AND course = #{course}
            </if>
            <if test="courseTimeBegin!=null ">
                AND courseTime >= #{courseTimeBegin}
            </if>
            <if test="courseTimeEnd!=null ">
                AND courseTime &lt;= #{courseTimeEnd}
            </if>
            <if test="week!=null and week!=''">
                AND week = #{week}
            </if>
            <if test="duration!=null and duration!=''">
                AND duration = #{duration}
            </if>
            <if test="amAndPm!=null and amAndPm!=''">
                AND amAndPm = #{amAndPm}
            </if>
            <if test="num!=null and num!=''">
                AND num = #{num}
            </if>
            <if test="bookNum!=null and bookNum!=''">
                AND bookNum = #{bookNum}
            </if>
            <if test="advanceTimeBegin!=null">
                AND advanceTime >= #{advanceTimeBegin}
            </if>
            <if test="advanceTimeEnd!=null  ">
                AND advanceTime &lt;= #{advanceTimeEnd}
            </if>
            <if test="courseHour!=null ">
                AND courseHour = #{courseHour}
            </if>
            <if test="courseHourType!=null and courseHourType!=''">
                AND courseHourType = #{courseHourType}
            </if>
            <if test="state!=null and state!=''">
                AND state = #{state}
            </if>
            <if test="createTimeBegin!=null">
                AND createTime >= #{createTimeBegin}
            </if>
            <if test="createTimeEnd!=null ">
                AND createTime &lt;= #{createTimeEnd}
            </if>
            <if test="updateTimeBegin!=null ">
                AND updateTime >= #{updateTimeBegin}
            </if>
            <if test="updateTimeEnd!=null ">
                AND updateTime &lt;= #{updateTimeEnd}
            </if>
            <if test="vn!=null and vn!=''">
                AND vn = #{vn}
            </if>
        </where>
    </sql>


    <select id="CourseTimetable.count" resultType="int">
        SELECT count(1) FROM course_timetable
        <include refid="CourseTimetable.where"/>
    </select>


    <select id="CourseTimetable.query" resultMap="rs_base">
        SELECT
        <include refid="CourseTimetable.columns"/>
        FROM course_timetable
        <include refid="CourseTimetable.where"/>
        ORDER BY timetableCode DESC
    </select>


    <!--查询课表信息-->
    <select id="CourseTimetable.loadCourseTimetable" resultMap="rs_base_all">
        SELECT * FROM course_timetable  WHERE timetableCode = #{timetableCode}
    </select>

    <!--classroom 查詢詳情接口-->
    <select id="CourseTimetable.loadCourseTimetable4Classroom" resultMap="rs_base4classroom">
        SELECT * FROM course_timetable  WHERE timetableCode = #{timetableCode}
    </select>

    <!--查询课表信息-->
    <select id="CourseTimetable.loadByTimetableCode" resultMap="rs_base">
        SELECT * FROM course_timetable  WHERE timetableCode = #{timetableCode}
    </select>


    <!--更新课表状态-->
    <update id="CourseTimetable.updateByState" parameterType="CourseTimetable">
        UPDATE course_timetable SET
        state = #{newState} ,
        updateTime = #{updateTime},
        vn = vn+1
        WHERE
        timetableCode = #{timetableCode}
        AND state=#{oldState}
        AND vn=#{oldVn}
    </update>


    <!--查询课堂列表-->
    <select id="CourseTimetable.listTutorTimetable" resultMap="rs_base">
        SELECT
        <include refid="CourseTimetable.columns"/>
        FROM course_timetable
        <include refid="CourseTimetable.listWhere"/>
        ORDER BY timetableCode DESC
    </select>

    <select id="CourseTimetable.countTutorTimetable" resultType="int">
        SELECT count(1)
        FROM course_timetable
        <include refid="CourseTimetable.listWhere"/>
    </select>


    <!--根据条件搜索课程-->
    <select id="CourseTimetable.timetableTutorList" resultMap="rs_base_all4Search">
        SELECT DISTINCT ct.tutorCode
        FROM course_timetable ct,Tutor tutor
        <where>
            <if test="courseCodes!=null and courseCodes!=''">
                AND ct.courseCode in
                <foreach collection="courseCodes" item="courseCode_in" index="index" open="(" close=")" separator=",">
                    #{courseCode_in}
                </foreach>
            </if>
            <if test="tuTimeZone!=null and tuTimeZone!=''">
                AND ct.tuTimeZone = #{tuTimeZone}
            </if>
            <if test="courseTimeBegin!=null ">
                AND ct.courseTime >= #{courseTimeBegin}
            </if>
            <if test="courseTimeEnd!=null ">
                AND ct.courseTime &lt;= #{courseTimeEnd}
            </if>
            <if test="tutorState!=null ">
                AND tutor.state = #{tutorState}
                AND ct.tutorCode=tutor.tutorCode
            </if>
        </where>
        ORDER BY timetableCode DESC
    </select>

    <select id="CourseTimetable.countTimetableTutor" resultType="int">
        SELECT count(DISTINCT ct.tutorCode)
        FROM course_timetable ct,Tutor tutor
        <where>
            <if test="courseCodes!=null and courseCodes!=''">
                AND ct.courseCode in
                <foreach collection="courseCodes" item="courseCode_in" index="index" open="(" close=")" separator=",">
                    #{courseCode_in}
                </foreach>
            </if>
            <if test="tuTimeZone!=null and tuTimeZone!=''">
                AND ct.tuTimeZone = #{tuTimeZone}
            </if>
            <if test="courseTimeBegin!=null ">
                AND ct.courseTime >= #{courseTimeBegin}
            </if>
            <if test="courseTimeEnd!=null ">
                AND ct.courseTime &lt;= #{courseTimeEnd}
            </if>
            <if test="tutorState!=null ">
                AND tutor.state = #{tutorState}
                AND ct.tutorCode=tutor.tutorCode
            </if>
        </where>
    </select>


    <sql id="CourseTimetable.listWhere">
        <where>
            <if test="timetableCode!=null and timetableCode!=''">
                AND timetableCode = #{timetableCode}
            </if>
            <if test="courseCode!=null and courseCode!=''">
                AND courseCode = #{courseCode}
            </if>
            <if test="tutorCode!=null and tutorCode!=''">
                AND tutorCode = #{tutorCode}
            </if>
            <if test="tuTimeZone!=null and tuTimeZone!=''">
                AND tuTimeZone = #{tuTimeZone}
            </if>
            <if test="course!=null and course!=''">
                AND course = #{course}
            </if>
            <if test="courseTimeBegin!=null ">
                AND courseTime >= #{courseTimeBegin}
            </if>
            <if test="courseTimeEnd!=null ">
                AND courseTime &lt;= #{courseTimeEnd}
            </if>
            <if test="week!=null and week!=''">
                AND week = #{week}
            </if>
            <if test="duration!=null and duration!=''">
                AND duration = #{duration}
            </if>
            <if test="amAndPm!=null and amAndPm!=''">
                AND amAndPm = #{amAndPm}
            </if>
            <if test="num!=null and num!=''">
                AND num = #{num}
            </if>
            <if test="bookNum!=null and bookNum!=''">
                AND bookNum = #{bookNum}
            </if>
            <if test="advanceTimeBegin!=null ">
                AND advanceTime >= #{advanceTimeBegin}
            </if>
            <if test="advanceTimeEnd!=null ">
                AND advanceTime &lt;= #{advanceTimeEnd}
            </if>
            <if test="courseHour!=null ">
                AND courseHour = #{courseHour}
            </if>
            <if test="courseHourType!=null and courseHourType!=''">
                AND courseHourType = #{courseHourType}
            </if>
            <if test="state!=null and state!=''">
                AND state = #{state}
            </if>
            <if test="createTimeBegin!=null ">
                AND createTime >= #{createTimeBegin}
            </if>
            <if test="createTimeEnd!=null ">
                AND createTime &lt;= #{createTimeEnd}
            </if>
            <if test="updateTimeBegin!=null ">
                AND updateTime >= #{updateTimeBegin}
            </if>
            <if test="updateTimeEnd!=null ">
                AND updateTime &lt;= #{updateTimeEnd}
            </if>
        </where>
    </sql>
</mapper>

