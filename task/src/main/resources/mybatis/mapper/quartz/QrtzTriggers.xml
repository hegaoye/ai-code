<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<!-- 不使用namespace的话sql搜索定位会比较方便 -->
<mapper namespace="QrtzTriggers">

    <resultMap id="QrtzTriggers" type="QrtzTriggers">
        <result property="schedName" column="SCHED_NAME"/>
        <result property="triggerName" column="TRIGGER_NAME"/>
        <result property="triggerGroup" column="TRIGGER_GROUP"/>
        <result property="jobName" column="JOB_NAME"/>
        <result property="jobGroup" column="JOB_GROUP"/>
        <result property="description" column="DESCRIPTION"/>
        <result property="nextFireTime" column="NEXT_FIRE_TIME"/>
        <result property="prevFireTime" column="PREV_FIRE_TIME"/>
        <result property="priority" column="PRIORITY"/>
        <result property="triggerState" column="TRIGGER_STATE"/>
        <result property="triggerType" column="TRIGGER_TYPE"/>
        <result property="startTime" column="START_TIME"/>
        <result property="endTime" column="END_TIME"/>
        <result property="calendarName" column="CALENDAR_NAME"/>
        <result property="misfireInstr" column="MISFIRE_INSTR"/>
        <result property="jobData" column="JOB_DATA"/>
    </resultMap>

    <!-- 用于select查询公用抽取的列 -->
    <sql id="columns">
	    <![CDATA[


		SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP,JOB_NAME,JOB_GROUP,DESCRIPTION,NEXT_FIRE_TIME,PREV_FIRE_TIME,PRIORITY,TRIGGER_STATE,TRIGGER_TYPE,START_TIME,END_TIME,CALENDAR_NAME,MISFIRE_INSTR,JOB_DATA


        ]]>
	</sql>


    <insert id="insert" useGeneratedKeys="true" keyProperty="schedName" parameterType="QrtzTriggers">
        INSERT INTO qrtz_triggers (
        SCHED_NAME ,
        TRIGGER_NAME ,
        TRIGGER_GROUP ,
        JOB_NAME ,
        JOB_GROUP ,
        DESCRIPTION ,
        NEXT_FIRE_TIME ,
        PREV_FIRE_TIME ,
        PRIORITY ,
        TRIGGER_STATE ,
        TRIGGER_TYPE ,
        START_TIME ,
        END_TIME ,
        CALENDAR_NAME ,
        MISFIRE_INSTR ,
        JOB_DATA
        ) VALUES (
        #{schedName} ,
        #{triggerName} ,
        #{triggerGroup} ,
        #{jobName} ,
        #{jobGroup} ,
        #{description} ,
        #{nextFireTime} ,
        #{prevFireTime} ,
        #{priority} ,
        #{triggerState} ,
        #{triggerType} ,
        #{startTime} ,
        #{endTime} ,
        #{calendarName} ,
        #{misfireInstr} ,
        #{jobData}
        )
        <selectKey keyProperty="id" resultType="long">
            select LAST_INSERT_ID()
        </selectKey>
    </insert>

    <update id="update" parameterType="QrtzTriggers">
        UPDATE qrtz_triggers SET
	        JOB_NAME = #{jobName} ,
	        JOB_GROUP = #{jobGroup} ,
	        DESCRIPTION = #{description} ,
	        NEXT_FIRE_TIME = #{nextFireTime} ,
	        PREV_FIRE_TIME = #{prevFireTime} ,
	        PRIORITY = #{priority} ,
	        TRIGGER_STATE = #{triggerState} ,
	        TRIGGER_TYPE = #{triggerType} ,
	        START_TIME = #{startTime} ,
	        END_TIME = #{endTime} ,
	        CALENDAR_NAME = #{calendarName} ,
	        MISFIRE_INSTR = #{misfireInstr} ,
	        JOB_DATA = #{jobData} 
        WHERE 
	        SCHED_NAME = #{schedName}  AND 
	        TRIGGER_NAME = #{triggerName}  AND 
	        TRIGGER_GROUP = #{triggerGroup} 
	</update>

    <delete id="delete">
        DELETE FROM qrtz_triggers WHERE
        SCHED_NAME = #{id}  AND 
        TRIGGER_NAME = #{id}  AND 
        TRIGGER_GROUP = #{id} 
    </delete>

    <select id="load" resultMap="QrtzTriggers">
        SELECT
        <include refid="columns"/>
        <![CDATA[
		    FROM qrtz_triggers 
	        WHERE 
		        SCHED_NAME = #{id}  AND 
		        TRIGGER_NAME = #{id}  AND 
		        TRIGGER_GROUP = #{id} 
	    ]]>
    </select>

    <sql id="where">
        <where>
            <if test="@Ognl@isNotEmpty(schedName)">
                AND SCHED_NAME = #{schedName}
            </if>
            <if test="@Ognl@isNotEmpty(triggerName)">
                AND TRIGGER_NAME = #{triggerName}
            </if>
            <if test="@Ognl@isNotEmpty(triggerGroup)">
                AND TRIGGER_GROUP = #{triggerGroup}
            </if>
            <if test="@Ognl@isNotEmpty(jobName)">
                AND JOB_NAME = #{jobName}
            </if>
            <if test="@Ognl@isNotEmpty(jobGroup)">
                AND JOB_GROUP = #{jobGroup}
            </if>
            <if test="@Ognl@isNotEmpty(description)">
                AND DESCRIPTION = #{description}
            </if>
            <if test="@Ognl@isNotEmpty(nextFireTime)">
                AND NEXT_FIRE_TIME = #{nextFireTime}
            </if>
            <if test="@Ognl@isNotEmpty(prevFireTime)">
                AND PREV_FIRE_TIME = #{prevFireTime}
            </if>
            <if test="@Ognl@isNotEmpty(priority)">
                AND PRIORITY = #{priority}
            </if>
            <if test="@Ognl@isNotEmpty(triggerState)">
                AND TRIGGER_STATE = #{triggerState}
            </if>
            <if test="@Ognl@isNotEmpty(triggerType)">
                AND TRIGGER_TYPE = #{triggerType}
            </if>
            <if test="@Ognl@isNotEmpty(startTime)">
                AND START_TIME = #{startTime}
            </if>
            <if test="@Ognl@isNotEmpty(endTime)">
                AND END_TIME = #{endTime}
            </if>
            <if test="@Ognl@isNotEmpty(calendarName)">
                AND CALENDAR_NAME = #{calendarName}
            </if>
            <if test="@Ognl@isNotEmpty(misfireInstr)">
                AND MISFIRE_INSTR = #{misfireInstr}
            </if>
            <if test="@Ognl@isNotEmpty(jobData)">
                AND JOB_DATA = #{jobData}
            </if>
        </where>
    </sql>


    <select id="count" resultType="long">
        SELECT count(1) FROM qrtz_triggers
        <include refid="where"/>
    </select>


    <select id="query" resultMap="QrtzTriggers">
        SELECT
        <include refid="columns"/>
        FROM qrtz_triggers
        <include refid="where"/>

        <if test="@Ognl@isNotEmpty(sortColumns)">
            ORDER BY ${sortColumns}
        </if>
    </select>

    <!--查询作业信息集合-->
    <select id="listTriggers" resultMap="QrtzTriggers">
        SELECT * FROM qrtz_triggers limit 100
    </select>
    <select id="countTriggers" resultType="int">
        SELECT COUNT(1) FROM qrtz_triggers
    </select>

</mapper>

